<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTracker</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background-color: #2A363B;
            color: #FECEAB; /* Color for axes and labels */
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            font-size: 20px; /* Base font size */
        }

        svg {
            display: block;
            margin: auto;
        }

        .legend {
            background-color: #2A363B;
            border-radius: 5px;
            padding: 10px;
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1rem; /* Font size for legend */
            z-index: 100;
        }

        .legend-item {
            margin-bottom: 0.5rem; /* Spacing between legend items */
        }

        .axis text {
            font-size: 1rem; /* Font size for axes */
        }
    </style>
</head>
<body>
    <!-- Timeline Chart -->
    <svg id="timeline"></svg>
    <!-- Legend for Timeline Chart -->
    <div class="legend" id="legend"></div>

    <!-- D3 Chart -->
    <div id="chart"></div>

    <script>
        // Fetch data for Timeline Chart
        fetch('https://api.tinybird.co/v0/pipes/timeline.json?token=p.eyJ1IjogIjkyMTY1Nzk1LWIxNDMtNDhmZC1iZDk0LTk1MmE2NWIxOTY2MiIsICJpZCI6ICJkMjdlYjFhZi0wMThjLTQ2OGMtYTM2Yy0wMjQwOGNkZjg5ZGUiLCAiaG9zdCI6ICJldV9zaGFyZWQifQ.9IdP76HEHwZE0MBQK2gYOgxiYdi1fS81d5WmYbTx8AE')
            .then(response => response.json())
            .then(data => {
                // Display Timeline Chart
                renderTimelineChart(data["data"]);
                // Create legend for Timeline Chart
                createTimelineLegend(data["data"]);
            })
            .catch(error => console.error('Error fetching timeline data:', error));

        // Fetch data for D3 Chart
        fetch('https://api.tinybird.co/v0/pipes/active_app.json?token=p.eyJ1IjogIjkyMTY1Nzk1LWIxNDMtNDhmZC1iZDk0LTk1MmE2NWIxOTY2MiIsICJpZCI6ICJkMjdlYjFhZi0wMThjLTQ2OGMtYTM2Yy0wMjQwOGNkZjg5ZGUiLCAiaG9zdCI6ICJldV9zaGFyZWQifQ.9IdP76HEHwZE0MBQK2gYOgxiYdi1fS81d5WmYbTx8AE')
            .then(response => response.json())
            .then(data => {
                // Convert duration from seconds to hours and minutes
                data.data.forEach(d => {
                    const hours = Math.floor(d.duration / 3600);
                    const minutes = Math.floor((d.duration % 3600) / 60);
                    d.durationFormatted = `${hours}:${minutes}`;
                });

                // Display D3 Chart
                renderD3Chart(data.data);
            })
            .catch(error => console.error('Error fetching D3 data:', error));

        // Function to render Timeline Chart
        function renderTimelineChart(data) {
            const svg = d3.select("#timeline");
            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight * 2 / 3;
            const margin = { top: 20, right: 30, bottom: 30, left: 140 };
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;
            svg.attr("width", containerWidth).attr("height", containerHeight);

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const parseTime = d3.timeParse("%H:%M:%S");

            const x = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleTime()
                .domain([parseTime("05:00:00"), parseTime("23:59:59")])
                .range([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(["unlocked", "locked"])
                .range(["#E84A5F", "#99B89800"]);

            g.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.date))
                .attr("y", d => y(parseTime(d.end_timestamp.split(' ')[1])))
                .attr("width", x.bandwidth())
                .attr("height", d => y(parseTime(d.start_timestamp.split(' ')[1])) - y(parseTime(d.end_timestamp.split(' ')[1])))
                .attr("fill", d => color(d.status));

            g.append("g")
                .attr("class", "axis axis-x")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            g.append("g")
                .attr("class", "axis axis-y")
                .call(d3.axisLeft(y)
                    .tickFormat(d3.timeFormat("%H:%M"))
                    .ticks(d3.timeMinute.every(30))); // Show all hours
        }

        // Function to create legend for Timeline Chart
        function createTimelineLegend(data) {
            const legendDiv = document.getElementById("legend");
            const parseTime = (timeString) => {
                const [hours, minutes, seconds] = timeString.split(":").map(Number);
                return (hours * 60) + minutes + (seconds / 60);
            };

            const dataByDay = data.reduce((acc, curr) => {
                const date = curr.date;
                const duration = parseTime(curr.end_timestamp.split(" ")[1]) - parseTime(curr.start_timestamp.split(" ")[1]);
                acc[date] = (acc[date] || 0) + (curr.status === "unlocked" ? duration : 0);
                return acc;
            }, {});

            for (const [date, duration] of Object.entries(dataByDay)) {
                const totalHours = Math.floor(duration / 60);
                const totalMinutes = Math.round(duration % 60);
                const legendItem = document.createElement("div");
                legendItem.classList.add("legend-item");
                legendItem.textContent = `${date}: ${totalHours}:${totalMinutes < 10 ? '0' : ''}${totalMinutes} hours`;
                legendDiv.appendChild(legendItem);
            }
        }

        // Function to render D3 Chart
        function renderD3Chart(data) {
            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const containerWidth = window.innerWidth / 3;
            const containerHeight = window.innerHeight / 3;
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;

            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            let ww = width + margin.left + margin.right + 140;
            d3.select("#chart").attr("style", "width:" + parseInt(ww, 10) + "px")

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.app))
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data, d => d.duration)]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .call(d3.axisLeft(y)
                    .tickFormat(d => {
                        const hours = Math.floor(d / 3600);
                        const minutes = Math.floor((d % 3600) / 60);
                        return `${hours}:${minutes}`;
                    }));

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.app))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.duration))
                .attr("height", d => height - y(d.duration))
                .attr("fill", "steelblue")
                .append("title")
                .text(d => `App: ${d.app}\nDuration: ${d.durationFormatted} hours`);
        }
    </script>
</body>
</html>
