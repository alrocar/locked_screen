<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline con D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background-color: #2A363B;
            color: #FECEAB; /* Color para los ejes y etiquetas */
        }
    </style>
</head>
<body>
    <svg id="timeline" width="800" height="400"></svg>

    <script>
        function obtenerDatos() {
            fetch('https://api.tinybird.co/v0/pipes/untitled_pipe_8665.json?token=p.eyJ1IjogIjU3ODJhNDZmLTlkZDgtNGM0NS04YjM1LWM0ODhjNjFjMWNjNiIsICJpZCI6ICI1ZDViMWM4Zi1iM2MzLTQ1YmUtOWFkYy01OGE5OWUwNWNjNzIiLCAiaG9zdCI6ICJldV9zaGFyZWQifQ.sPdaYLNuiMOJMCIl35wLbP0QJad8pk6fnQug-4Zz4A0')
                .then(response => response.json())
                .then(data => {
                    // Una vez que se obtienen los datos, accedemos a la propiedad "data"
                    const datos = data["data"];
                    // Luego podemos llamar a la función para montar la gráfica con estos datos
                    montarGrafica(datos);
                })
                .catch(error => console.error('Error al obtener los datos:', error));
        }

        function montarGrafica(data) {
            const svg = d3.select("#timeline");
            const margin = { top: 20, right: 30, bottom: 30, left: 140 };
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const parseTime = d3.timeParse("%H:%M:%S");

            const x = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleTime()
                .domain([parseTime("00:00:00"), parseTime("23:59:59")])
                .range([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(["unlocked", "locked"])
                .range(["#E84A5F", "#99B898"]);

            g.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.date))
                .attr("y", d => y(parseTime(d.end_timestamp.split(' ')[1])))
                .attr("width", x.bandwidth())
                .attr("height", d => y(parseTime(d.start_timestamp.split(' ')[1])) - y(parseTime(d.end_timestamp.split(' ')[1])))
                .attr("fill", d => color(d.status));

            g.append("g")
                .attr("class", "axis axis-x")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            g.append("g")
                .attr("class", "axis axis-y")
                .call(d3.axisLeft(y).tickFormat(d3.timeFormat("%H:%M:%S")));
        }

        window.onload = obtenerDatos;
    </script>
</body>
</html>

